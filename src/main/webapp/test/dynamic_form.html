<!DOCTYPE html>
<html lang="en-US">
<head>
	<meta charset="UTF-8">
	<title>Dynamic form</title>
<script src="../js/require.js"> </script>
<script src="../js/requireconfig.js"> </script>

<style type="text/css">
.ui-widget, body{
font-size: .9em!important;
}

label{
width: 300px;
font-family: arial; 
display: inline-block;
box-sizing: border-box;
}
input,select{
width: 150px;
padding: 0;
box-sizing: border-box;
}
.even-odd-container{

}
.even-odd-container div{
box-sizing: border-box;
}
.fieldbox{
min-width: 450px;
float:left;
padding: 5px;
margin: 0px;
} 
.fieldbox label{
float: left;
display: inline-block;

}
</style>
<script type="text/javascript">
define('df',['app/cssloader','jqueryui', 'jsviews', 'canjs',"uidataview","uidataviewlocal",  'jsonpath', 'gridpager','gridfilter','gridfilterform'],function(cssloader){
	cssloader.loadCss(['jqueryui'],'',null);
	var data = {
			page: 1,
			total: 20, 
			data: [{name: "samarjit", email: "samarjit.s@ycs.com", dob: "2013-06-12", ismarried: "N", num_cars: 5, num_child: 2},
	           {name: "siva", email: "siva.koti@ycs.com", dob: "2012-08-12", ismarried: "Y", num_cars: 20, num_child: 3}]
	};
	
	var model = [
	             {name: "name", type: "string", capturetype: "text", displaytype: "displayText", label: "Name", searchable: true, isPartOfKey: true, convertToModel: null /*view to model*/, convertToView: null /*model to view*/ 	},
	             {name: "email", type: "string", capturetype: "email", displaytype: "displayText", label: "Email", searchable: true, isPartOfKey: true, convertToModel: null /*view to model*/, convertToView: null /*model to view*/ 	},
	             {name: "dob", type: "string", capturetype: "datepicker", displaytype: "displayText", label: "Date Of Birth", searchable: true, isPartOfKey: false, convertToModel: null /*view to model*/, convertToView: null /*model to view*/ 	},
	             {name: "ismarried", type: "string", capturetype: "checkbox", displaytype: "displayText", label: "Married", searchable: false, isPartOfKey: false, convertToModel: null /*view to model*/, convertToView: null /*model to view*/ 	},
	             {name: "num_cars", type: "int", capturetype: "slider", displaytype: "displayText", label: "Num Cars", searchable: false, isPartOfKey: false, convertToModel: null /*view to model*/, convertToView: null /*model to view*/ 	},
	             {name: "num_child", type: "int", capturetype: "spinner", displaytype: "displayText", label: "Num Child", searchable: true, isPartOfKey: false, convertToModel: null /*view to model*/, convertToView: null /*model to view*/ 	}
	            ];
	//em px converter from filamentgroup
	$.fn.toEm = function(settings){
		settings = jQuery.extend({
			scope: 'body'
		}, settings);
		var that = parseInt(this[0],10),
			scopeTest = jQuery('<div style="display: none; font-size: 1em; margin: 0; padding:0; height: auto; line-height: 1; border:0;">&nbsp;</div>').appendTo(settings.scope),
			scopeVal = scopeTest.height();
		scopeTest.remove();
		return (that / scopeVal).toFixed(8) + 'em';
	};


	$.fn.toPx = function(settings){
		settings = jQuery.extend({
			scope: 'body'
		}, settings);
		var that = parseFloat(this[0]),
			scopeTest = jQuery('<div style="display: none; font-size: 1em; margin: 0; padding:0; height: auto; line-height: 1; border:0;">&nbsp;</div>').appendTo(settings.scope),
			scopeVal = scopeTest.height();
		scopeTest.remove();
		return Math.round(that * scopeVal) + 'px';
	};
	
		var spineDatepicker =  {
	 		fromElm: null,
	 		name: "datepicker",
	 		render: function ($form, field,  mode  ){
	 			var html =  $.templates("#tmpl_datepicker_"+mode).render(field); // can.view("#tmpl_datepicker_"+mode, field);
				$form.append(html);	
				var fieldWidgets = $("[data-spine-prop='"+field.name+"']");
				fieldWidgets.datepicker();
	 		},
	 		getValue: function($el){
	 			return $el.val();
	 		},
	 		setValue: function($el, val){
	 			$el.val(val);
	 		},
	 		showError: function($el){
	 			
	 		},
	 		showTooltip: function($el){
	 			
	 		}
	 	};
	 	
		var spineSpinner =  {
	 		fromElm: null,
	 		name: "spinner",
	 		render: function ($form, field,  mode  ){
	 			var html =  $.templates("#tmpl_spinner_"+mode).render(field); // can.view("#tmpl_datepicker_"+mode, field);
				$form.append(html);	
				var fieldWidgets = $("[data-spine-prop='"+field.name+"']");
				 
				var fontSize = $(.9).toPx();
				
				fieldWidgets.spinner();
			 	//fieldWidgets.height(20);
			 	//fieldWidgets.parent().height(20)
				fieldWidgets.outerHeight(fieldWidgets.parent().height());
				fieldWidgets.outerWidth(150-24);

				
				fieldWidgets.parent().css("font-size","0px");
				fieldWidgets.parent().css("width","150px");
				fieldWidgets.css("font-size",".8em");
				fieldWidgets.css("font-size",fontSize);
				/*
				//another way to position correctly
				//fieldWidgets.css("position","absolute");
				//fieldWidgets.css("top","0");
				
				*/
				//fieldWidgets.css("line-height",".8em"); //not required
				
				fieldWidgets.css("margin-top","0px");
				fieldWidgets.css("margin-bottom","0px");
				fieldWidgets.css("margin-left","2px");
				
				fieldWidgets.css("vertical-align","top");
				
				
			 
	 		},
	 		getValue: function($el){
	 			return $el.val();
	 		},
	 		setValue: function($el, val){
	 			$el.val(val);
	 		},
	 		showError: function($el){
	 			
	 		},
	 		showTooltip: function($el){
	 			
	 		}
	 	};
	 	
		var spineSlider =  {
	 		fromElm: null,
	 		name: "slider",
	 		render: function ($form, field,  mode  ){
	 			var html =  $.templates("#tmpl_slider_"+mode).render(field); // can.view("#tmpl_datepicker_"+mode, field);
				$form.append(html);	
				var fieldWidgets = $("[data-spine-prop='"+field.name+"']");
				fieldWidgets.slider();
				
	 		},
	 		getValue: function($el){
	 			return $el.data('ui-slider').value();
	 		},
	 		setValue: function($el, val){
	 			$el.data('ui-slider').value(val);
	 		},
	 		showError: function($el){
	 			
	 		},
	 		showTooltip: function($el){
	 			
	 		}
	 	};
	 	
		var spineText =  {
	 		fromElm: null,
	 		name: "text",
	 		render: function ($form, field,  mode  ){
	 			var html =  $.templates("#tmpl_text_"+mode).render(field); // can.view("#tmpl_datepicker_"+mode, field);
				$form.append(html);	
				var fieldWidgets = $("[data-spine-prop='"+field.name+"']");
				 
	 		},
	 		getValue: function($el){
	 			return $el.val();
	 		},
	 		setValue: function($el, val){
	 			$el.val(val);
	 		},
	 		showError: function($el){
	 			
	 		},
	 		showTooltip: function($el){
	 			
	 		}
	 	};
		
		var spineDisplayText =  {
	 		fromElm: null,
	 		name: "displayText",
	 		render: function ($form, field,  mode  ){
	 			var html =  $.templates("#tmpl_text_view").render(field); // can.view("#tmpl_datepicker_"+mode, field);
				$form.append(html);	
				var fieldWidgets = $("[data-spine-prop='"+field.name+"']");
				 
	 		},
	 		getValue: function($el){
	 			return $el.text();
	 		},
	 		setValue: function($el, val){
	 			$el.text(val);
	 		},
	 		showError: function($el){
	 			
	 		},
	 		showTooltip: function($el){
	 			
	 		}
	 	};
		
		var spineCheckbox =  {
	 		fromElm: null,
	 		name: "checkbox",
	 		render: function ($form, field,  mode  ){
	 			var html =  $.templates("#tmpl_check_edit").render(field); // can.view("#tmpl_datepicker_"+mode, field);
				$form.append(html);	
				var fieldWidgets = $("[data-spine-prop='"+field.name+"']");
				fieldWidgets.css("margin","0px");
	 		},
	 		getValue: function($el){
	 			 if($el.is(":checked")){
	 				return $el.val();
	 			 }else{
	 				 return "";
	 			 }
	 		},
	 		setValue: function($el, val){
	 			$el.val(val);
	 			console.log("check value ==== "+val)
	 			
	 			if(val == 'y' )$el[0].checked = true;
	 			if(val == 'Y' )$el[0].checked = true;
	 			if(/true/i.test(val) )$el[0].checked = true;
	 			if(val == 'Yes' )$el[0].checked = true;
	 			if(val == true )$el[0].checked = true;
	 			
	 			if(val == 'n' )$el[0].checked = false
	 			if(val == 'N' )$el[0].checked = false
	 			if(/false/i.test(val) )$el[0].checked = false
	 			if(val == 'No' )$el[0].checked = false
	 			if(val == false )$el[0].checked = false
	 		},
	 		showError: function($el){
	 			
	 		},
	 		showTooltip: function($el){
	 			
	 		}
	 	};
	 	
		$.widgetList = {};
	 	$.widgetList ["datepicker"] =  spineDatepicker;
	 	$.widgetList ["spinner"] =  spineSpinner;
	 	$.widgetList ["slider"] =  spineSlider;
	 	$.widgetList ["text"] =  spineText;
	 	$.widgetList ["email"] =  spineText;
	 	$.widgetList ["displayText"] =  spineDisplayText;
	 	$.widgetList ["checkbox"] =  spineCheckbox;
	 	
	 	
	 	var widgetHelper = {
			render: function ($form, field, mode  ){
				var wiz = null ;
				if(mode == 'edit'){
					if(field.capturetype == null || field.capturetype == ""){
						console.log('render: capturetype:'+ field.capturetype + " not found in model using text");
						field.capturetype = "text";
					}
					
					wiz = $.widgetList [field.capturetype];
					
					if(wiz == null || wiz == ""){
						console.log('render: capturetype:'+ field.capturetype + " is invalid using default text");
						wiz = $.widgetList ["text"];
					}
				}else{
					//view
					if(field.displaytype == null || field.displaytype == ""){
						console.log('render: displaytype:'+ field.capturetype + " not found in model using displayText");
						field.displaytype = "displayText";
					}
					
					wiz = $.widgetList [field.displaytype];
					
					if(wiz == null || wiz == ""){
						console.log('render: displaytype:'+ field.capturetype + " is invalid, using displayText");
						wiz = $.widgetList ["text"];
					}
				}
				
				if(wiz == null || wiz == ""){
					console.log('render: capturetype/displaytype:'+ field.capturetype + " not found in widget registry for mode="+mode);
				}else{
					wiz.render($form, field, mode)
				}
	 		},
	 		getValue: function($el){
	 			var wizType = $el.data("spine-type");
	 			if(wizType == null || wizType == ""){
					console.log('getValue: wizType: '+ wizType + " not found in data-spine-type");
				}else{
					var wiz = $.widgetList [wizType];
					if(wiz == null || wiz == ""){
						console.log('getValue: wizType: '+ wizType + " not found in widget registry");
					}else{
						console.log('getValue: wizType: '+ wizType );
						return wiz.getValue($el);
					}
				}
	 			return null;
	 		},
	 		setValue: function($el, val){
	 			var wizType = $el.data("spine-type");
	 			if(wizType == null || wizType == ""){
					console.log('setValue: wizType: '+ wizType + " not found in data-spine-type");
				}else{
					var wiz = $.widgetList [wizType];
					if(wiz == null || wiz == ""){
						console.log('setValue: wizType: '+ wizType + " not found in widget registry");
					}else{
						wiz.setValue($el, val);
					}
					 
				}
	 			
	 		},
	 		showError: function($el){
	 			
	 		},
	 		showTooltip: function($el){
	 			
	 		}
	 	};
	 	
	 
	ArrayReader = function (fields) {
		
		if ($.isFunction(window["wijmoASPNetParseOptions"])) {
			wijmoASPNetParseOptions(fields);
		}

		if ($.isArray(fields)) {
			this.fields = fields;
		}
	};
	window.ArrayReader = ArrayReader;

	$.extend(ArrayReader.prototype, {
		read: function (datasource) {
			if ($.isArray(datasource.data)) {
				datasource.items = this._map(datasource.data);
			}
			else {
				datasource.items = [];
			}
		},

		_map: function (data) {
			var self = this, arr = [];
			if (self.fields === undefined || self.fields.length === 0) {
				$.extend(true, arr, data);
				return arr;
			}
			else {
				$.each(data, function (index, value) {
					var i = {};
					$.each(self.fields, function (index, field) {
						// mapping property is a function,
						// the return value will be used as value.
						
						//handle the juice
						if($.type(field) == "string" ) {
							var tmp = field;
							field = {name: tmp, mapping: tmp};
						}
						if (field.mapping && typeof field.mapping && window[field.mapping]) {
							field.mapping = window[field.mapping];
						}

						if ($.isFunction(field.mapping)) {
							i[field.name] = field.mapping(value);
							return true;
						}
						// use string field mapping or number index mapping.
						var mapping = field.mapping !== undefined ?
											field.mapping : field.name,
						v = value[mapping];
						if (v === undefined) {
							if (field.defaultValue !== undefined) {
								v = field.defaultValue;
							}
							else {
								v = value;
							}
						}
						i[field.name] = v;
					});
					arr.push(i);
				});
			}
			return arr;
		}
	});
	
	function schemaReader (newoptions) {
			this.options = {
				rootList: "data",
				meta: "",
				datatype: "json",
				items: [],
				resultFields: model//[{name: "name",  mapping: "name" /*can be xpath,json path or javascript function*/}, {name: "email"}]
			};
			
			$.extend(this.options, newoptions);
			
			this.read = function(obj){
				//debugger; 
				var temp = jsonPath(obj,"$."+ this.options.rootList)[0];
				//return $.map(temp[0], function(o) {   if(o.name) return {name: "samar"}; })
				var datasource = {data: temp} ;
				 new ArrayReader(this.options.resultFields).read(datasource);
				return datasource.items;
			}
	}; 
	
	$.widget("uix.datasource",$.ui.dataviewlocal,  {
				widgetEventPrefix: "dataview",
				options:{
					model: model,
					reader: new schemaReader(),
					//source: function (){ _super(); },
					url:"",
					editurl: "",
					cellediturl: "",
					filter: [],
					sort: [],
					i18n: {},
					validation: {},
					paging :{ 
						offset: 0,
						limit: 1
					},
					dataLocation: "local",
					pagingtype: "remote",
					filterType: "remote"
				},
				_init: function(){
					this.option(this.options);
					this.result = [];
					this._fetch();
					var that = this;
					
					/*this.options.source = function (request,response){
							console.log("data ==== "+data);
						//that._super();
					};*/
				},
				_fetch: function(){
					if(this.options.dataLocation == "local"){
						this.options.input = this.options.reader.read(this.options.rawdata); 
					}else if(this.options.dataLocation == "remote"){
						
					}
				},
				refresh: function(){
				   this._fetch();
				   this._super();
				},
				get: function (prop){
					if(this.options.paging.offset > this.result.length -1){
						console.log("ERROR: datasource: trying to get offset more than result set length, selecting last object in result array");
						this.options.paging.offset = this.result.length -1;
					}
					if(this.result[this.options.paging.offset] == null){
						return "";
					}
					return this.result[this.options.paging.offset][prop];
				},
				save: function(){
					//retrieve data
					var that = this;
					 $.each(datasource.options.model, function(i,field){
						// var field = $.grep(datasource.options.model, function (i){ if(i.name == fld) return i; });
						var fieldWidgets = $("[data-spine-prop='"+field.name+"']");
						/*
						if(fieldWidgets.data("spine-type") == "datepicker"){
							that.result[that.options.paging.offset][field.name] = widgetHelper.getValue(fieldWidgets); 
						}else if(fieldWidgets.data("spine-type") == "slider"){
							that.result[that.options.paging.offset][field.name] =fieldWidgets.slider("value"  );
						}else if(fieldWidgets.data("spine-type") == "spinner"){
							that.result[that.options.paging.offset][field.name] =fieldWidgets.spinner("value"  );
						}else {
							that.result[that.options.paging.offset][field.name] = fieldWidgets.val();
						}
						*/
						that.result[that.options.paging.offset][field.name] =  widgetHelper.getValue(fieldWidgets );
						
					 });
					
					console.log("saving ... "+JSON.stringify(this.result));
				}
				
	});
	
	var datasource = $.uix.datasource({rawdata: data});
	var panel_fields = ["name","email","dob","ismarried"];
	
	
	$("#dynpager").pager({source: datasource});
 	
 	
	function createViewController(containerEl, datasource, mode){
		$(containerEl).addClass("even-odd-container");
		var $form = $(containerEl);
		$form.empty();
		
		
		
		//create fields
		 $.each(datasource.options.model, function(i, field){
			// var field = $.grep(datasource.options.model, function (i){ if(i.name == fld.name) return i; });
			widgetHelper.render($form, field, mode); 
			/*if(field.capturetype == "datepicker" ){
				 
				  
				
			 }else if(field.capturetype == "spinner" ){
				 var html =  $.templates("#tmpl_number_"+mode).render(field); // can.view("#tmpl_datepicker_"+mode, field);
					$form.append(html);	
					var fieldWidgets = $("[data-spine-prop='"+field.name+"']");
					fieldWidgets.spinner();
			 }else if(field.capturetype == "slider" ){
				 var html =  $.templates("#tmpl_slider_"+mode).render(field); // can.view("#tmpl_datepicker_"+mode, field);
					$form.append(html);	
					var fieldWidgets = $("[data-spine-prop='"+field.name+"']");
					//fieldWidgets.prop("type","text");
					fieldWidgets.slider();
			 
			 }else{
				 
				var html =  $.templates("#tmpl_text_"+mode).render(field);
					$form.append(html); 
			 }*/
				 
		 });
		 
		//populate data
		 $.each(datasource.options.model, function(i,field){
			// var field = $.grep(datasource.options.model, function (i){ if(i.name == fld) return i; });
			var fieldWidgets = $("[data-spine-prop='"+field.name+"']");
			widgetHelper.setValue(fieldWidgets, datasource.get(field.name));
			/*if(fieldWidgets.data("spine-type") == "datepicker"){		widgetHelper.setValue(fieldWidgets, datasource.get(field.name));
				
			}else if(fieldWidgets.data("spine-type") == "slider"){				fieldWidgets.slider("value",datasource.get(field.name) );
				
			}else if(fieldWidgets.data("spine-type") == "spinner"){				fieldWidgets.spinner("value",datasource.get(field.name) );
				
			}else { 			fieldWidgets.val( datasource.get(field.name) );
			}
			
			
			if(mode == "view"){
				if(fieldWidgets.data("spine-type") == "datepicker"){
					fieldWidgets.text( datasource.get(field.name) )
				}else {
					fieldWidgets.text( datasource.get(field.name) );
				}
			}
			*/
			
		 });
	}
	
	function createSearchForm(containerEl, datasource, mode){
		$(containerEl).addClass("even-odd-container");
		var $form = $(containerEl);
		$form.empty();
		
		datasource.refresh();
		var searchModel  = $.map(datasource.options.model, function (v,i){ if( v.searchable == "true"||v.searchable == true ) return v; }); 
		$.each(searchModel, function(i, field){
			widgetHelper.render($form, field, "edit"); 
		});
		////----create button panel----
		
	}
	
	createViewController("#dynaform",datasource, "edit");
	createSearchForm ("#dynsearch",datasource, "search");
	$(datasource).on("dataviewresponse", function(){
		createViewController("#dynaform",datasource, "edit");
	})
	datasource.refresh();
	
	return {
		data: data, model: model,reader: schemaReader, datasource: datasource, createViewController: createViewController, createSearchForm: createSearchForm 
	}
});
var x = null;
require(['df'], function(y){ x = y;});
</script>	
<script type="text/template" id="tmpl_datepicker_edit">
<div class="fieldbox">	<label for="caption">{{:label}}  </label> <input type="text" data-spine-type="{{:capturetype}}" data-spine-prop="{{:name}}" name="{{:name}}" value="" /></div>
</script>
 
<script type="text/template" id="tmpl_text_edit">
<div class="fieldbox">	<label for="caption">{{:label}}</label> <input type="text" name="{{:name}}" data-spine-prop="{{:name}}" data-spine-type="text" value="Field Details" /></div>
</script>

<script type="text/template" id="tmpl_text_view">
<div class="fieldbox">	<label for="caption">{{:label}}</label> <span type="text" name="{{:name}}" data-spine-prop="{{:name}}" data-spine-type="displayText" value="Field Details" ></span></div>
</script>

<script type="text/template" id="tmpl_number_edit">
<div class="fieldbox">	<label for="caption">{{:label}}  </label> <input type="text" name="{{:name}}" data-spine-prop="{{:name}}"  value="Field Details" /></div>
</script>

<script type="text/template" id="tmpl_spinner_edit">
<div class="fieldbox">	<label for="caption">{{:label}}</label> <input type="text" name="{{:name}}" data-spine-prop="{{:name}}" data-spine-type="spinner"  value="Field Details" /></div>
</script>
 
<script type="text/template" id="tmpl_slider_edit">
<div class="fieldbox">	<label for="caption">{{:label}}</label> <div type="text" name="{{:name}}" data-spine-prop="{{:name}}" data-spine-type="slider" style="width:150px;display: inline-block"  value="Field Details" ></div></div>
</script>

<script type="text/template" id="tmpl_check_edit">
<div class="fieldbox">	<label for="caption">{{:label}}  </label> <input type="checkbox" name="{{:name}}" data-spine-prop="{{:name}}" data-spine-type="checkbox"  value="Field Details" ></span></div>
</script>



</head>

<body>
	
	<div id="dynaform"></div>
	<div style="clear: left"></div>
	<div id="dynsearch"></div> 
	
	<div style="clear: left"></div>
	<div id='dynpager' ></div>
</body>
</html>